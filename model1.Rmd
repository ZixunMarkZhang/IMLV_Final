# [Logistic Regression]

In this section, we will create a logistic regression model and try to interpret the most important variables and their influence on the target variables. The detailed information of the model is indicated as below.

```{r message=FALSE, warning=FALSE, cache=TRUE}
#build Logistic regression model
fullmod<-glm(y~.,data=train_dat,family=binomial(link = 'logit'))
LRpred = predict(fullmod,test_dat,type = 'response')
summary(fullmod)
```

```{r message=FALSE, warning=FALSE,cache=TRUE}
library(caret)
library(reshape2)
library(tibble)
library(ggplot2)
library(tidyverse)
library(fastshap)
pred <- function(model, newdata) {
  predict(model, newdata = newdata, type = "terms")
}
shap_values <- fastshap::explain(
  fullmod, 
  X = train_dat,           
  feature_names = colnames(train_dat |> dplyr::select(-y)),
  pred_wrapper = pred, 
  nsim = 5,
  newdata = test_dat
)

ggplot(melt(shap_values),aes(value, reorder(variable, value, FUN = abs)))+
  geom_boxplot()
```

After the logistic regression models are built, we may access the feature importance by shapley value plot. The plot above is showing the shapley value of each variable sorted by their absolute values.

```{r message=FALSE, warning=FALSE,cache=TRUE}
library(pdp)
pdp_hit_rf = partial(object = fullmod,pred.var = 'priceIndex',prob = TRUE,type = 'classification')
g <- ggplot(pdp_hit_rf, aes(priceIndex, yhat)) +
  geom_line() +
  geom_rug(data = train_dat, aes(priceIndex), inherit.aes = FALSE, alpha = .5,
  color = "red") +
  theme_bw(16)
g+ylab('prob')
```

```{r message=FALSE, warning=FALSE,cache=TRUE}
library(pdp)
pdp_hit_rf = partial(fullmod,pred.var = 'InterestRateindex',prob = TRUE,type = 'classification')
g <- ggplot(pdp_hit_rf, aes(InterestRateindex,yhat)) +
  geom_line() +
  geom_rug(data = train_dat, aes(InterestRateindex), inherit.aes = FALSE, alpha = .5,
  color = "red") +
  theme_bw(16)
g+ylab('prob')
```

```{r warning=FALSE,cache=TRUE}
library(pdp)
pdp_hit_rf = partial(fullmod,pred.var = 'campaign',prob = TRUE,type = 'classification')
g <- ggplot(pdp_hit_rf, aes(campaign, yhat)) +
  geom_line() +
  geom_rug(data = train_dat, aes(campaign), inherit.aes = FALSE, alpha = .5,
  color = "red") +
  theme_bw(16)
g+ylab('prob')
```

```{r, cache=TRUE}
get_rates <- function(threshold, actual, response) {
  predicted <- ifelse(response < threshold, 0, 1)
  TP <- sum(actual == 1 & predicted == 1)
  FP <- sum(actual == 0 & predicted == 1)
  TN <- sum(actual == 0 & predicted == 0)
  FN <- sum(actual == 1 & predicted == 0)
  
  tpr <- TP/(TP + FN)
  fpr <- FP/(TN + FP)  
  
  data.frame(threshold, tpr, fpr)
  
}


rocdf <- map_df(seq(0, 1, .01), get_rates, test_dat$y=='yes', LRpred)
rocdf <- rocdf |> 
  mutate(label = ifelse(threshold %in% seq(0, 1, .01),
                        threshold, NA))
library(ggrepel)
g <- ggplot(rocdf, aes(x = fpr, y = tpr, label = label)) +
  geom_point() +
  geom_path() +
  geom_label_repel(color = "blue", size = 2)
plotly::ggplotly(g)
```




